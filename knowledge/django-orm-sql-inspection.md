# Django ORM SQL Inspection Methods

8 techniques for inspecting SQL generated by Django's ORM during development and debugging.

Source: https://b0uh.github.io/django-show-me-the-sql.html

## 1. Using `.query` Attribute

Simplest method - add `.query` to any queryset:

```python
qs = User.objects.filter(username="gustave")
print(qs.query)
```

**Limitation**: Doesn't work for expressions that don't return a QuerySet (`.count()`, `.exists()`, etc.)

## 2. Using `connection.queries`

Requires `DEBUG = True` in settings:

```python
from django.db import connection, reset_queries

# reset_queries()  # Optional, clears query list
print(connection.queries)
```

Returns list of all queries executed with timing info.

## 3. Logging Configuration

Add a DEBUG logger for `django.db.backends`:

```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django.db.backends': {
            'handlers': ['console'],
            'level': 'DEBUG',
        },
    },
}
```

**Tip**: Add debug log statements in your code to correlate SQL with source location.

## 4. Using `CaptureQueriesContext`

Context manager for targeted query capture:

```python
from django.db import connection
from django.test.utils import CaptureQueriesContext

with CaptureQueriesContext(connection) as ctx:
    # your code here
    print(ctx.captured_queries)
```

Great for tests and isolating specific code paths.

## 5. Django Debug Toolbar

For web development, install the toolbar and check the "SQL" panel:

```bash
pip install django-debug-toolbar
```

Follow setup instructions at https://django-debug-toolbar.readthedocs.io/

**Must-have for web development** - shows queries per request with timing and EXPLAIN.

## 6. Debug Toolbar's `debugsqlshell`

Shell with query timing:

```bash
./manage.py debugsqlshell
>>> User.objects.count()
```

Shows execution time for each query.

## 7. django-extensions `shell_plus --print-sql`

```bash
pip install django-extensions
./manage.py shell_plus --print-sql
>>> User.objects.count()
```

Prints SQL for every query in the shell session.

## 8. django-extensions `runserver_plus --print-sql`

```bash
pip install django-extensions Werkzeug
./manage.py runserver_plus --print-sql
```

Logs SQL for all HTTP requests.

**Killer feature**: Add `--print-sql-location` for stack traces showing where each query originates.

## When to Use Which

| Method | Use Case |
|--------|----------|
| `.query` | Quick one-off inspection of a queryset |
| `connection.queries` | See all queries in a code block |
| Logging | Always-on visibility in development |
| `CaptureQueriesContext` | Tests, asserting query counts |
| Debug Toolbar | Web requests, performance profiling |
| `debugsqlshell` | Interactive exploration with timing |
| `shell_plus --print-sql` | Shell exploration, query patterns |
| `runserver_plus --print-sql-location` | Finding source of N+1 queries |
