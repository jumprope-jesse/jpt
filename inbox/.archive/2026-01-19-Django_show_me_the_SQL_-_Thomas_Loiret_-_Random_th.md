---
type: link
source: notion
url: https://b0uh.github.io/django-show-me-the-sql.html?utm_campaign=Django%2BNewsletter&utm_medium=rss&utm_source=Django_Newsletter_221
notion_type: Tech Deep Dive
tags: ['Running']
created: 2024-03-01T15:33:00.000Z
---

# Django: show me the SQL - Thomas Loiret - Random thoughts

## AI Summary (from Notion)
- The document discusses methods for inspecting SQL generated by Django's ORM.
- There are 8 different methods highlighted for inspecting SQL:
1. Using the query attribute: Allows direct access to the SQL query of a queryset.
2. Using connection.queries: Requires DEBUG mode to be enabled; this captures all queries executed during the request.
3. In the logs: Set up Django logging to capture SQL queries with a DEBUG logger for django.db.backends.
4. Using CaptureQueriesContext: A context manager that captures queries executed within its scope.
5. Using Django Debug Toolbar: A popular tool that provides real-time SQL query information while developing.
6. Using Django Debug Toolbar and debugsqlshell: Allows for SQL query execution in a shell while capturing execution time.
7. Using django-extensions and shell_plus: A command to run the Django shell and print SQL for queries executed.
8. Using django-extensions and runserver_plus: Extends the Django development server to log SQL queries, with additional features like stack traces for better debugging.
- Key Takeaway: Debugging SQL queries in Django can be approached through multiple methods, each with its own advantages and ideal use cases.
- The document emphasizes the importance of understanding SQL queries for optimizing performance and debugging issues in Django applications.

## Content (from Notion)

Here are 8 different ways of inspecting the SQL generated by the ORM of Django.

1. Using the query attribute
1. Using connection.queries
1. In the logs
1. Using CaptureQueriesContext
1. Using Django Debug Toolbar
1. Using Django Debug Toolbar and debugsqlshell
1. Using django-extensions and shell_plus
1. Using django-extensions and runserver_plus
# Using the query attribute

Add .query to your queryset. For example:

```plain text
qs = User.objects.filter(username="gustave")
print(qs.query)

```

Note: this does not work for the expressions that do not return a QuerySet. For example, those ending with .count() or .exists().

# Using connection.queries

1. In your Django settings make sure DEBUG is set to True
1. In your code do:
```plain text
from django.db import connection, reset_queries
# reset_queries() # Optional, will empty the query list
print(connection.queries)

```

Official documentation: here

# In the logs

Add a django.db.backends logger at the level DEBUG in settings.py.

```plain text
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django.db.backends': {
            'handlers': ['console'],
            'level': 'DEBUG',
        },
    },
}

```

Tip: add debug log in your code to find where SQL is coming from. The logs

# Using CaptureQueriesContext

```plain text
from django.db import connection
from django.test.utils import CaptureQueriesContext

with CaptureQueriesContext(connection) as ctx:
    # your code here
    print(ctx.captured_queries)

```

Thanks to Seb for pointing out that solution to me.

# Using Django Debug Toolbar

The initial effort to install the toolbar is a bit higher than the other methods. But when working on a website, this is a must have.

1. Install it following the instructions here
1. Open the page you want to inspect in your browser and check out the "SQL" section.
# Using Django Debug Toolbar and debugsqlshell

1. Install it following the instructions here
1. ./manage.py debugsqlshell
1. In the shell do a query, for example: User.objects.count()
This method also display the time the query took to be executed which can be useful.

Official documentation: here

Thanks to Tim for pointing out that solution to me.

# Using django-extensions and shell_plus

1. python -m pip install django-extensions
1. ./manage.py shell_plus --print-sql
1. In the shell do a query, for example: User.objects.count()
Official documentation: here

# Using django-extensions and runserver_plus

1. python -m pip install django-extensions Werkzeug
1. ./manage.py runserver_plus --print-sql
1. Do some HTTP requests and look in the logs for the SQL generated
1. Killer feature: you can also pass the argument -print-sql-location and a stacktrace will be added to each SQL query to help you find from where it is coming.
Those parameters are not officially documented, but do exist in the code.


